{% extends "base.html" %}
{% block title %}Dashboard | {% endblock %}

{% block content %}
<div class="container-fluid py-2">
    <!-- Título -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold mb-0">
            <i class="bi bi-speedometer2 me-2 text-primary"></i>Panel de Estadísticas
        </h3>
        <button class="btn btn-sm btn-outline-dark" onclick="cargarIndicadores()">
            <i class="bi bi-arrow-clockwise me-1"></i>Actualizar
        </button>
    </div>

    <!-- Indicadores -->
    <div class="row g-3 mb-4" id="indicadoresContainer">
        <div class="col-md-2 col-6">
            <div class="card border-0 shadow-sm rounded-4 text-center p-3">
                <small class="text-muted">Total acciones</small>
                <h4 id="cardTotalAcciones" class="fw-bold mb-0">-</h4>
            </div>
        </div>
        <div class="col-md-2 col-6">
            <div class="card border-0 shadow-sm rounded-4 text-center p-3">
                <small class="text-muted">Encender (%)</small>
                <h4 id="cardEncender" class="fw-bold text-success mb-0">-</h4>
            </div>
        </div>
        <div class="col-md-2 col-6">
            <div class="card border-0 shadow-sm rounded-4 text-center p-3">
                <small class="text-muted">Apagar (%)</small>
                <h4 id="cardApagar" class="fw-bold text-danger mb-0">-</h4>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="card border-0 shadow-sm rounded-4 text-center p-3">
                <small class="text-muted">Dispositivo más usado</small>
                <h5 id="cardMasUsado" class="fw-bold mb-0">-</h5>
            </div>
        </div>
        <div class="col-md-3 col-6">
            <div class="card border-0 shadow-sm rounded-4 text-center p-3">
                <small class="text-muted">Usuarios activos (24h)</small>
                <h4 id="cardUsuarios" class="fw-bold mb-0">-</h4>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row g-4">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-4 grafico-card">
                <div class="card-body d-flex flex-column justify-content-between align-items-center">
                    <h6 class="fw-bold mb-3 w-100">
                        Acciones registradas por día
                    </h6>
                    <div class="grafico-wrapper">
                        <canvas id="graficoAcciones"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-4 grafico-card">
                <div class="card-body d-flex flex-column justify-content-between align-items-center">
                    <h6 class="fw-bold mb-3 w-100">
                        Distribución de acciones por dispositivo
                    </h6>
                    <div class="grafico-wrapper">
                        <canvas id="graficoDispositivos"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-4 grafico-card">
                <div class="card-body d-flex flex-column justify-content-between align-items-center">
                    <h6 class="fw-bold mb-3 w-100">
                        Proporción de ENCENDER vs APAGAR
                    </h6>
                    <div class="grafico-wrapper">
                        <canvas id="graficoTiempo"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card border-0 shadow-sm rounded-4 grafico-card">
                <div class="card-body d-flex flex-column justify-content-between align-items-center">
                    <h6 class="fw-bold mb-3 w-100">
                        Acciones por Usuario
                    </h6>
                    <div class="grafico-wrapper">
                        <canvas id="graficoUsuarios"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    cargarIndicadores();
    cargarGraficos();
});

// =======================
// Indicadores
// =======================
async function cargarIndicadores() {
    try {
        const res = await fetch("/api/estadisticas/indicadores");
        const data = await res.json();
        if (!data.success) throw new Error("Error al obtener indicadores");

        const i = data.indicadores;
        document.getElementById("cardTotalAcciones").textContent = i.total_acciones;
        document.getElementById("cardEncender").textContent = `${i.porcentaje_encender}%`;
        document.getElementById("cardApagar").textContent = `${i.porcentaje_apagar}%`;
        document.getElementById("cardMasUsado").textContent = i.dispositivo_mas_usado;
        document.getElementById("cardUsuarios").textContent = i.usuarios_activos_24h;

        cargarGraficos();
    } catch (err) {
        console.error("Error en cargarIndicadores:", err);
    }
}

// =======================
// Gráficos
// =======================
function cargarGraficos() {
    cargarGraficoAcciones();
    cargarGraficoDispositivos();
    cargarGraficoTiempo();
    cargarGraficoUsuarios();
}

// ----------- Acciones por día -----------
let chartAcciones;
async function cargarGraficoAcciones() {
    try {
        const res = await fetch("/api/estadisticas/acciones-diarias");
        const data = await res.json();
        if (chartAcciones) chartAcciones.destroy();

        const ctx = document.getElementById("graficoAcciones").getContext("2d");
        chartAcciones = new Chart(ctx, {
            type: "line",
            data: {
                labels: data.labels,
                datasets: [{
                    label: "Acciones por día",
                    data: data.data,
                    borderColor: "rgba(13, 110, 253, 0.8)",
                    backgroundColor: "rgba(13, 110, 253, 0.2)",
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { mode: 'index', intersect: false }
                },
                interaction: { mode: 'nearest', intersect: false },
                scales: {
                    x: { title: { display: true, text: "Fecha" } },
                    y: { beginAtZero: true, title: { display: true, text: "Cantidad de acciones" } }
                }
            }
        });
    } catch (err) {
        console.error("Error en cargarGraficoAcciones:", err);
    }
}

// ----------- Distribución por dispositivo -----------
let chartDispositivos;
async function cargarGraficoDispositivos() {
    try {
        const res = await fetch("/api/estadisticas/acciones-por-dispositivo");
        const data = await res.json();
        if (chartDispositivos) chartDispositivos.destroy();

        const ctx = document.getElementById("graficoDispositivos").getContext("2d");
        chartDispositivos = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: [
                        "rgba(13, 110, 253, 0.7)",
                        "rgba(25, 135, 84, 0.7)",
                        "rgba(220, 53, 69, 0.7)",
                        "rgba(255, 193, 7, 0.7)",
                        "rgba(111, 66, 193, 0.7)"
                    ],
                    borderColor: "#fff",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                cutout: "70%",
                plugins: {
                    legend: { position: "bottom", labels: { boxWidth: 12 } },
                    tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed} acciones` } }
                }
            }
        });
    } catch (err) {
        console.error("Error en cargarGraficoDispositivos:", err);
    }
}

// ----------- ENCENDER vs APAGAR -----------
let chartTiempo;
async function cargarGraficoTiempo() {
    try {
        const res = await fetch("/api/estadisticas/acciones-por-tipo");
        const data = await res.json();
        if (chartTiempo) chartTiempo.destroy();

        const ctx = document.getElementById("graficoTiempo").getContext("2d");
        chartTiempo = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: ["rgba(25, 135, 84, 0.8)", "rgba(220, 53, 69, 0.8)"],
                    borderColor: "#fff",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                cutout: "65%",
                plugins: {
                    legend: { position: "bottom" },
                    tooltip: { callbacks: { label: ctx => `${ctx.label}: ${ctx.parsed}` } }
                }
            }
        });
    } catch (err) {
        console.error("Error en cargarGraficoTiempo:", err);
    }
}

// ----------- Acciones por Usuario -----------
let chartUsuarios;
async function cargarGraficoUsuarios() {
    try {
        const res = await fetch("/api/estadisticas/acciones-por-usuario");
        const data = await res.json();
        if (chartUsuarios) chartUsuarios.destroy();

        const ctx = document.getElementById("graficoUsuarios").getContext("2d");
        chartUsuarios = new Chart(ctx, {
            type: "bar",
            data: {
                labels: data.labels,
                datasets: [{
                    label: "Cantidad de acciones",
                    data: data.data,
                    backgroundColor: "rgba(13, 110, 253, 0.7)",
                    borderColor: "rgba(0,0,0,0.1)",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                indexAxis: "y",
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, title: { display: true, text: "Acciones ejecutadas" } },
                    y: { title: { display: true, text: "Usuario" } }
                }
            }
        });
    } catch (err) {
        console.error("Error en cargarGraficoUsuarios:", err);
    }
}
</script>
{% endblock %}
