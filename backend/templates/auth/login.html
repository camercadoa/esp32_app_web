{% extends "base.html" %} {% block title %}Iniciar Sesión{% endblock %} {% block
content %}
<div
  class="d-flex justify-content-center align-items-center"
  style="height: 80vh"
>
  <div class="card shadow p-4" style="max-width: 420px; width: 100%">
    <div class="text-center mb-4">
      <i class="bi bi-shield-lock fs-1 text-primary"></i>
      <h4 class="fw-bold mt-2">Inicio de Sesión</h4>
      <p class="text-muted mb-0">Accede a tu cuenta</p>
    </div>

    <form id="loginForm">
      <div class="mb-3">
        <label for="username" class="form-label">Usuario</label>
        <input
          type="text"
          id="username"
          class="form-control"
          placeholder="Ingrese su usuario"
          required
        />
      </div>

      <div class="mb-3">
        <label for="password" class="form-label">Contraseña</label>
        <input
          type="password"
          id="password"
          class="form-control"
          placeholder="Ingrese su contraseña"
          required
        />
      </div>

      <div id="alertaLogin" class="alert alert-danger d-none py-2 small"></div>

      <button type="submit" class="btn btn-primary w-100">
        <i class="bi bi-box-arrow-in-right me-1"></i> Entrar
      </button>
    </form>

    <div class="text-center mt-3 small">
      ¿No tienes cuenta?
      <a href="{{ url_for('auth.registro') }}">Regístrate aquí</a>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const username = document.getElementById("username").value.trim();
    const password = document.getElementById("password").value.trim();
    const alerta = document.getElementById("alertaLogin");

    alerta.classList.add("d-none");
    alerta.textContent = "";

    try {
      const response = await fetch("/api/usuarios/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password }),
      });

      const data = await response.json();

      if (!response.ok) {
        alerta.textContent = data.error || "Error al iniciar sesión";
        alerta.classList.remove("d-none");
        return;
      }

      // Guardar token en localStorage
      localStorage.setItem("jwt_token", data.token);
      localStorage.setItem("usuario_nombre", data.usuario.nombre);
      localStorage.setItem("usuario_username", data.usuario.username);

      // Redirigir al home
      window.location.href = "{{ url_for('app.home') }}";
    } catch (error) {
      console.error("Error:", error);
      alerta.textContent = "No se pudo conectar con el servidor.";
      alerta.classList.remove("d-none");
    }
  });
</script>
{% endblock %}
